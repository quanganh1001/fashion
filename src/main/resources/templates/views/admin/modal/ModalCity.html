<div th:fragment="ModalCity">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Thêm thành phố</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="col-12 d-flex justify-content-between">
                    <div class="col-10"><input type="text" class="form-control" id="input-city"></div>
                    <button class="btn btn-primary" id="add-city">Thêm</button>
                </div>
                <ul th:if="${cities != null}" class="mt-3" id="list-city">
                    <li th:each="city :${cities}" class="mt-3">
                        <button class=" delete btn btn-danger" th:data-id="${city.cityId}">Xóa</button>
                        <span th:text=" ${city.name}"
                              class="fw-bold">
                        </span>
                    </li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class=" btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
    <script>
        function updateListCity(){
            $.ajax({
                type: 'GET',
                url: '/admin/store/list-city',
                success: (data) => {
                    $("#city").html(data)
                },
                error: (jqXHR) => {
                    alert(jqXHR.responseText)
                }
            });
        }
        $(document).ready(() => {
            const csrfToken = $("meta[name='_csrf']").attr("content");
            const csrfHeader = $("meta[name='_csrf_header']").attr("content");
            $(".delete").click((btn) => {
                const cityId = $(btn.target).attr("data-id");
                $.ajax({
                    type: 'DELETE',
                    url: '/admin/store/delete-city',
                    data: {cityId: cityId},
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    },
                    success: (data) => {
                        $("#modal").html(data);
                        updateListCity();
                    },
                    error: (jqXHR) => {
                        alert(jqXHR.responseText)
                    }
                });
            })
            $("#add-city").click(() => {
                const newCity = $("#input-city").val();
                if (newCity === "") {
                    alert("Chưa nhập tên thành phố!")
                } else {
                    $.ajax({
                        type: 'POST',
                        url: '/admin/store/add-city',
                        data: {newCity: newCity},
                        beforeSend: function (xhr) {
                            // Sử dụng tên HTTP header chuẩn và giá trị token
                            xhr.setRequestHeader(csrfHeader, csrfToken);
                        },
                        success: (data) => {
                            $("#modal").html(data);
                            updateListCity();
                        },
                        error: (jqXHR) => {
                            alert(jqXHR.responseText)
                        }
                    });
                }
            })
        })
    </script>
</div>